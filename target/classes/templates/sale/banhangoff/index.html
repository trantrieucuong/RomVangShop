<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta charset="UTF-8"/>
    <title>R∆°m V√†ng - Trang qu·∫£n tr·ªã</title>
    <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport'/>
    <link rel="icon" href="/assets/img/icon.ico" type="image/x-icon"/>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts and icons -->
    <script src="/assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
		WebFont.load({
			google: {"families":["Lato:300,400,700,900"]},
			custom: {"families":["Flaticon", "Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"], urls: ['/assets/css/fonts.min.css']},
			active: function() {
				sessionStorage.fonts = true;
			}
		});


    </script>

    <!-- CSS Files -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/atlantis.min.css">
    <!-- CSS Just for demo purpose, don't include it in your project -->
    <link rel="stylesheet" href="/assets/css/demo.css">
</head>
<body>
<div class="wrapper">
    <!-- Header -->

    <th:block th:replace="~{admin/fragments/header :: header}"></th:block>

    <!-- End Header -->

    <!-- Navbar -->

    <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>

    <!-- End Navbar -->

    <section class="content-wrapper p-4">
        <div class="pos-container flex gap-4">
            <!-- V√ôNG S·∫¢N PH·∫®M -->
            <div class="w-3/5 min-w-[65%] space-y-3">
                <div class="flex justify-between mb-4">
                    <input type="text" id="searchInput" placeholder="T√¨m s·∫£n ph·∫©m..."
                           class="border rounded px-2 py-1 w-1/2">
                    <select class="border rounded px-2 py-1" id="categorySelect">
                        <option value="">T·∫•t c·∫£</option>
                        <option th:each="cat : ${categories}"
                                th:value="${cat.categoryId}"
                                th:text="${cat.categoryName}"></option>
                    </select>
                </div>

                <div class="product-grid grid grid-cols-4 gap-3">
                    <div th:each="product : ${products}"
                         class="product-card border p-0.5 rounded-sm shadow-none text-[10px]"

                         th:attr="data-product-code=${product.productId}">

                        <div class="product-image-wrapper text-center">
                            <img th:src="@{'/loadImage?imageName='+${product.productImage}}"
                                 alt="·∫¢nh s·∫£n ph·∫©m"
                                 class="product-image w-16 h-16 object-cover mx-auto">
                        </div>

                        <div class="product-name font-medium text-center mt-1 truncate text-[12px]"
                             th:text="${product.productName}"></div>

                        <div class="product-info text-[11px] text-gray-600 text-center leading-tight">
                            <div th:text="'Gi√°: ' + ${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'ƒë'"></div>
                            <div>
                                T·ªìn kho: <span class="product-stock" th:text="${product.quantity}"></span>
                            </div>
                        </div>

                        <button class="select-btn bg-green-500 text-white px-1.5 py-1 rounded mt-1 w-full text-[11px]"
                                th:attr="data-code=${product.productId}, data-name=${product.productName}, data-price=${product.price}, data-quantity=${product.quantity}">
                            Ch·ªçn
                        </button>
                    </div>

                </div>

            </div>

            <!-- V√ôNG ƒê∆†N H√ÄNG -->
            <div class="pos-invoice w-[35%] min-w-[340px] flex-shrink-0 sticky top-4 self-start h-fit">
                <div class="order-header">
                    <div class="order-tabs-wrapper">
                        <div id="orderTabs" class="order-tabs"></div>
                    </div>
                    <br>

                </div>
                <button class="create-order-btn" onclick="createNewOrder()">+ ƒê∆°n H√†ng</button>


                <div id="orderContent" class="flex-1 overflow-y-auto border-t border-b py-2 space-y-2 text-sm"></div>

                <button onclick="clearCurrentOrder()"
                        class="w-full mt-2 bg-red-500 text-white py-1 rounded text-sm">üóë Clear
                </button>

                <div class="mt-2">
                    <label class="text-xs text-gray-500">Kh√°ch h√†ng</label>
                    <div class="input-search flex gap-2">
                        <input type="text" id="phoneInput"
                               class="w-full border p-1 rounded text-sm"
                               placeholder="Nh·∫≠p SƒêT">
                        <button onclick="searchCustomer()"
                                class="px-3 py-1 bg-gray-200 text-sm text-gray-700 rounded hover:bg-gray-300"
                                title="T√¨m kh√°ch h√†ng">
                            üîç
                        </button>


                    </div>
                    <div id="customerResult" class="mt-1 text-sm font-medium"></div>
                    <button id="openCustomerFormBtn">+ Kh√°ch h√†ng m·ªõi</button>
                </div>

                <div class="mt-4 border-t pt-2 text-sm">
                    <div class="flex justify-between">
                        <span>T·∫°m t√≠nh :</span><span id="subtotal">0ƒë</span>
                    </div>
                    <div class="flex justify-between font-semibold text-lg mt-1">
                        <span>T·ªïng :</span><span id="total">0ƒë</span>
                    </div>
                    <button onclick="showInvoice() " class="bg-green-500 text-white px-3 py-1 rounded">
                        Thanh to√°n
                    </button>
                </div>
            </div>

        </div>


        <!-- POPUP nh·∫≠p s·ªë l∆∞·ª£ng -->
        <div id="quantityModal" class="modal-overlay">
            <div class="modal-box">
                <h2 class="text-lg font-semibold mb-3 text-center">Nh·∫≠p s·ªë l∆∞·ª£ng</h2>
                <input type="number" id="quantityInput" class="w-full border rounded p-2 mb-3 text-center"
                       placeholder="S·ªë l∆∞·ª£ng">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal()" class="px-4 py-1 text-sm bg-gray-300 rounded hover:bg-gray-400">H·ªßy
                    </button>
                    <button onclick="addToOrder()"
                            class="px-4 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">Th√™m
                    </button>
                </div>
            </div>
        </div>
        <!-- invoice.html -->
        <!-- Popup H√≥a ƒë∆°n -->

        <div id="invoiceBackdrop"></div>

        <!-- Modal -->
        <div id="invoiceModal">
            <h2 class="text-xl font-bold text-center mb-2">ƒê∆†N H√ÄNG</h2>
            <p><strong>Th·ªùi gian:</strong> <span id="invTime"></span></p>
            <strong>M√£ ƒê∆†N H√ÄNG:</strong>
            <span id="invCode" data-order-id=""></span>
            </p>
            <p><strong>Kh√°ch h√†ng:</strong> <span id="invCustomer"></span></p>

            <table class="w-full mt-2 border-collapse border text-sm">
                <thead>
                <tr class="bg-gray-100">
                    <th class="border px-2 py-1">STT</th>
                    <th class="border px-2 py-1">T√™n SP</th>
                    <th class="border px-2 py-1">SL</th>
                    <th class="border px-2 py-1">ƒê∆°n gi√°</th>
                    <th class="border px-2 py-1">Th√†nh ti·ªÅn</th>
                </tr>
                </thead>
                <tbody id="invItems"></tbody>
                <tfoot>
                <tr>
                    <td colspan="4" class="text-right font-bold px-2 py-1 border">T·ªïng:</td>
                    <td class="border px-2 py-1 font-bold text-right" id="invTotal"></td>
                </tr>
                </tfoot>
            </table>

            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeInvoice()" class="px-3 py-1 bg-gray-300 rounded">ƒê√≥ng</button>
                <button onclick="showPaymentOptions();checkBill()"
                        class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                    Thanh to√°n
                </button>
            </div>
        </div>


        <!-- Modal ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n -->
        <div id="paymentOptionModal" class="payment-option-modal">
            <div class="payment-option-content">
                <h2 style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 16px;">Ch·ªçn ph∆∞∆°ng
                    th·ª©c
                    thanh to√°n</h2>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="payWithCash()"
                            style="padding: 10px; background-color: #22c55e; color: white; border-radius: 4px;">üíµ Ti·ªÅn
                        m·∫∑t
                    </button>
                    <button onclick="payOnline()"
                            style="padding: 10px; background-color: #3b82f6; color: white; border-radius: 4px;">
                        üí≥ Chuy·ªÉn kho·∫£n
                    </button>


                    <button onclick="closePaymentOptionModal()"
                            style="padding: 10px; background-color: #d1d5db; border-radius: 4px;">H·ªßy
                    </button>
                </div>
            </div>
        </div>
        <script>

<!--document.getElementById('paymentForm').addEventListener('submit', function (e) {-->
<!--    // L·∫•y t·ªïng ti·ªÅn-->
<!--    const totalText = document.getElementById('total').innerText;-->
<!--    const totalCleaned = totalText.replace(/[^\d]/g, '');-->
<!--    document.getElementById('amount').value = totalCleaned;-->

<!--    // L·∫•y m√£ ƒë∆°n h√†ng t·ª´ <span>-->
<!--    const maDonHang = document.getElementById('invCode').innerText;-->

<!--    // G√°n action c√≥ query param invCode-->
<!--    this.action = '/orders/createPaymentLinkSale?invCode=' + encodeURIComponent(maDonHang);-->
<!--});-->

document.getElementById('paymentForm').addEventListener('submit', function (e) {
    // L·∫•y t·ªïng ti·ªÅn
    const totalText = document.getElementById('total').innerText;
    const totalCleaned = totalText.replace(/[^\d]/g, '');
    document.getElementById('amount').value = totalCleaned;

    // ‚úÖ L·∫•y ƒë√∫ng orderId l√† s·ªë (v√≠ d·ª•: 48)
    const orderId = document.getElementById('invCode').dataset.orderId;

    if (!orderId) {
        alert("Kh√¥ng t√¨m th·∫•y orderId");
        e.preventDefault();
        return;
    }

    // ‚úÖ G√°n ƒë√∫ng query param orderId
    this.action = '/orders/createPaymentLinkSale?orderId=' + encodeURIComponent(orderId) + '&amount=' + totalCleaned;
});



        </script>
        <!-- Modal thanh to√°n ti·ªÅn m·∫∑t -->
        <div id="cashPaymentModal" class="cash-payment-modal">
            <div class="cash-payment-content">
                <h2 style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 16px;">Thanh to√°n ti·ªÅn
                    m·∫∑t</h2>
                <div style="font-size: 14px;">
                    <p><strong>T·ªïng ti·ªÅn:</strong> <span id="cashTotal" style="color: red; font-weight: bold;"></span>
                    </p>
                    <label>S·ªë ti·ªÅn kh√°ch ƒë∆∞a:</label>
                    <input type="number" id="cashReceived"
                           style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px;"
                           placeholder="Nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a">
                    <p><strong>Ti·ªÅn th·ª´a:</strong> <span id="cashChange" style="font-weight: bold;"></span></p>
                </div>
                <div style="margin-top: 16px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeCashModal()"
                            style="padding: 6px 12px; background-color: #d1d5db; border-radius: 4px;">ƒê√≥ng
                    </button>
                    <button onclick="confirmCashPayment()"
                            style="padding: 6px 12px; background-color: #22c55e; color: white; border-radius: 4px;">X√°c
                        nh·∫≠n
                    </button>
                </div>
            </div>
        </div>


        <!-- N√∫t m·ªü modal -->
        <!-- Modal th√™m kh√°ch h√†ng -->
        <!-- N√∫t m·ªü form -->
        <div id="customerModal" class="modal-overlay">
            <div class="modal-box">
                <h2>Th√™m kh√°ch h√†ng m·ªõi</h2>
                <form id="customerForm">
                    <input name="name" type="text" placeholder="H·ªç t√™n" required><br>
                    <input name="phone" type="text" placeholder="SƒêT"><br>
                    <input name="email" type="email" placeholder="Email"><br>


                    <div class="modal-actions">
                        <button type="button" id="closeCustomerModalBtn">H·ªßy</button>
                        <button type="submit">L∆∞u</button>
                    </div>


                </form>
            </div>
        </div>

        <!-- ‚úÖ Modal hi·ªÉn th·ªã h√≥a ƒë∆°n sau khi thanh to√°n -->
        <!-- Modal h√≥a ƒë∆°n -->
        <div id="invoiceModal-IV"
             style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 999;">
            <div class="invoice-box" id="invoiceToPrint"
                 style="background: white; padding: 20px; border-radius: 8px; max-width: 420px; width: 100%; font-family: Arial, sans-serif;">
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="/img/products/logo.jpg" alt="Logo" style="height: 60px; object-fit: contain;">
                    <h2 style="margin: 5px 0; font-size: 18px;">H√ìA ƒê∆†N B√ÅN H√ÄNG</h2>
                    <p style="font-size: 12px;">C·ª≠a h√†ng R∆°m V√†ng - Xin c·∫£m ∆°n qu√Ω kh√°ch!</p>
                </div>

                <div style="font-size: 13px; margin-bottom: 10px;">
                    <p><strong>M√£ h√≥a ƒë∆°n:</strong> <span id="invoiceCode"></span></p>
                    <p><strong>Th·ªùi gian:</strong> <span id="invoiceDate"></span></p>
                    <p><strong>Kh√°ch h√†ng:</strong> <span id="invoiceCustomer"></span></p>
                </div>

                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #ccc; padding: 4px;">SP</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">SL</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">ƒêG</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">TT</th>
                    </tr>
                    </thead>
                    <tbody id="invoiceItems"></tbody>
                    <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; border: 1px solid #ccc; padding: 4px;">
                            <strong>T·ªïng:</strong></td>
                        <td id="invoiceTotal" style="border: 1px solid #ccc; padding: 4px;"></td>
                    </tr>
                    </tfoot>
                </table>
                <br>
                <br>
                <br>
                <div class="footer-buttons"
                     style="margin-top: 12px; display: flex; justify-content: flex-end; gap: 8px;">
                    <button onclick="exportInvoiceToPDF()"
                            style="padding: 6px 12px; background: #22c55e; color: white; border-radius: 4px;">üìÑ T·∫£i PDF
                    </button>
                    <button onclick="viewInvoiceDetail()"
                            style="padding: 6px 12px; background: #3b82f6; color: white; border-radius: 4px;">Chi ti·∫øt
                    </button>
                    <button onclick="closeInvoiceModal()"
                            style="padding: 6px 12px; background: #d1d5db; border-radius: 4px;">ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal chuy·ªÉn kho·∫£n -->
        <div id="qrPaymentModal"
             style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 9999;">
            <div style="background: white; padding: 20px; border-radius: 8px; width: 340px; font-family: Arial;">
                <h3 style="text-align: center; font-weight: bold;">Chuy·ªÉn kho·∫£n qua VietQR</h3>
                <p><strong>Ng√¢n h√†ng:</strong> MB Bank</p>
                <p><strong>Ch·ªß t√†i kho·∫£n:</strong> L∆ØU NG·ªåC TUY√äN</p>
                <p><strong>S·ªë t√†i kho·∫£n:</strong> 804062004</p>
                <p><strong>S·ªë ti·ªÅn:</strong> <span id="qrAmount" style="color: red; font-weight: bold;"></span></p>
                <p><strong>N·ªôi dung:</strong> <span id="qrDescription" style="color: blue;"></span></p>
                <div style="text-align: center; margin: 10px 0;">
                    <img id="qrImage" src="" alt="QR" style="width: 200px; height: 200px;">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeQRModal()" style="padding: 6px 12px; background: #ccc; border-radius: 4px;">
                        H·ªßy
                    </button>
                </div>

            </div>
        </div>

        <div id="invoiceDetailModal"
             style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 9999;">
            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 100%; font-family: Arial, sans-serif;">
                <h3 style="text-align: center; font-size: 18px;">Chi ti·∫øt h√≥a ƒë∆°n</h3>
                <div id="invoiceDetailContent" style="margin-top: 10px; font-size: 14px;"></div>
                <div style="text-align: right; margin-top: 10px;">
                    <button onclick="closeInvoiceDetailModal()"
                            style="padding: 6px 12px; background: #ccc; border-radius: 4px;">ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>

        <!--                <select id="provinceSelect" name="province" required>-->
        <!--                    <option value="">Ch·ªçn t·ªânh / th√†nh</option>-->
        <!--                </select><br>-->
        <!--                <select id="districtSelect" name="district" disabled required>-->
        <!--                    <option value="">Ch·ªçn huy·ªán / qu·∫≠n</option>-->
        <!--                </select><br>-->
        <!--                <select id="wardSelect" name="ward" disabled required>-->
        <!--                    <option value="">Ch·ªçn x√£ / ph∆∞·ªùng</option>-->
        <!--                </select><br>-->
        <!--                <input name="houseNumber" type="text" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." required><br>-->


    </section>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


    <!-- End Custom template -->
</div>
<!--   Core JS Files   -->
<script src="/assets/js/core/jquery.3.2.1.min.js"></script>
<script src="/assets/js/core/popper.min.js"></script>
<script src="/assets/js/core/bootstrap.min.js"></script>
<!-- jQuery UI -->
<script src="/assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
<script src="/assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>

<!-- jQuery Scrollbar -->
<script src="/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
<!-- Datatables -->
<script src="/assets/js/plugin/datatables/datatables.min.js"></script>
<!-- Atlantis JS -->
<script src="/assets/js/atlantis.min.js"></script>
<!-- Atlantis DEMO methods, don't include it in your project! -->
<script src="/assets/js/setting-demo2.js"></script>
<script>
		$(document).ready(function() {
			$('#basic-datatables').DataTable({
			});

			$('#multi-filter-select').DataTable( {
				"pageLength": 5,
				initComplete: function () {
					this.api().columns().every( function () {
						var column = this;
						var select = $('<select class="form-control"><option value=""></option></select>')
						.appendTo( $(column.footer()).empty() )
						.on( 'change', function () {
							var val = $.fn.dataTable.util.escapeRegex(
								$(this).val()
								);

							column
							.search( val ? '^'+val+'$' : '', true, false )
							.draw();
						} );

						column.data().unique().sort().each( function ( d, j ) {
							select.append( '<option value="'+d+'">'+d+'</option>' )
						} );
					} );
				}
			});

			// Add Row
			$('#add-row').DataTable({
				"pageLength": 5,
			});

			var action = '<td> <div class="form-button-action"> <button type="button" data-toggle="tooltip" title="" class="btn btn-link btn-primary btn-lg" data-original-title="Edit Task"> <i class="fa fa-edit"></i> </button> <button type="button" data-toggle="tooltip" title="" class="btn btn-link btn-danger" data-original-title="Remove"> <i class="fa fa-times"></i> </button> </div> </td>';

			/* $('#addRowButton').click(function() {
				$('#add-row').dataTable().fnAddData([
					$("#addName").val(),
					$("#addPosition").val(),
					$("#addOffice").val(),
					action
					]);
				$('#addRowModal').modal('hide');

			}); */

			 $('#editRowButton').click(function(event) {
				/* $('#edit-row').dataTable().fnAddData([
					$("#categoryId").val(category.categoryId),
					$("#name").val(category.name),
					action
					]);
				$('#editRowModal').modal('hide'); */

				event.preventDefault();

				var href= $(this).attr('href');

				$.get(href, function(category){
					$('#categoryId').val(category.categoryId);
					$('#name').val(category.name);
				})

				$('#editRowModal').modal();

			});

			/* $('.table .btn').on('click', function(event){

				event.preventDefault();

				var href= $(this).attr('href');

				$.get(href, function(category){
					$('#categoryId').val(category.categoryId);
					$('#name').val(category.name);
				})

				$('#editRowModal').modal();
			}); */

		});




</script>

<!-- JAVASCRIPT -->
<script id="js">

// ========================== T·∫†O ƒê∆†N H√ÄNG ==========================
let orders = [];
let selectedOrderIndex = -1;
let selectedProduct = null;

async function createNewOrder() {
  // Gi·ªõi h·∫°n 5 ƒë∆°n h√†ng
  if (orders.length >= 5) {
    alert("Ch·ªâ cho ph√©p t·ªëi ƒëa 5 ƒë∆°n h√†ng c√πng l√∫c!");
    return;
  }

  try {
    const response = await fetch('/orders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
      }
    });

    if (!response.ok) throw new Error("T·∫°o ƒë∆°n h√†ng th·∫•t b·∫°i!");

    const newOrder = await response.json();

    orders.push({
      orderId: newOrder.orderId,       // ‚úÖ orderId t·ª´ server
      orderCode: newOrder.orderCode,   // ‚úÖ orderCode ƒë·ªÉ hi·ªÉn th·ªã
      items: []
    });

    selectedOrderIndex = orders.length - 1;
    renderOrderTabs();
    renderOrder();
  } catch (error) {
    console.error(error);
    alert("L·ªói khi t·∫°o ƒë∆°n h√†ng.");
  }
}

// ========================== HI·ªÇN TH·ªä TAB ƒê∆†N H√ÄNG ==========================
function renderOrderTabs() {
  const container = document.getElementById("orderTabs");
  container.innerHTML = "";

  // Ch·ªâ l·∫•y t·ªëi ƒëa 5 ƒë∆°n
  const limitedOrders = orders.slice(0, 5);

  limitedOrders.forEach((order, index) => {
    const btn = document.createElement("button");
    btn.textContent = order.orderCode || `DH${index + 1}`;
    btn.className = `text-sm px-2 py-1 border rounded ${index === selectedOrderIndex ? 'bg-yellow-400 text-black' : ''}`;
    btn.onclick = () => {
      selectedOrderIndex = index;
      renderOrderTabs();
      renderOrder();
    };
    container.appendChild(btn);
  });
}

// ========================== HI·ªÇN TH·ªä GI·ªé H√ÄNG ==========================
function renderOrder() {
  const content = document.getElementById("orderContent");
  content.innerHTML = "";

  if (selectedOrderIndex === -1) return;

  const items = orders[selectedOrderIndex].items;

  items.forEach((item, idx) => {
    const div = document.createElement("div");
    div.className = "order-item border-b py-2";

    div.innerHTML = `
      <div class="order-item-row flex justify-between items-center">
        <div class="item-left flex items-center gap-2">
          <img src="${item.image || '/default-image.png'}" alt="img" class="item-image w-12 h-12 object-cover rounded">
          <div class="item-info">
            <div class="item-name font-medium">${item.name}</div>
            <div class="item-price text-gray-600">${item.price.toLocaleString()}ƒë</div>
          </div>
        </div>
        <div class="item-right flex items-center gap-2">
          <button onclick="changeQty(${idx}, -1)" class="qty-btn px-2 bg-gray-200 rounded">‚àí</button>
          <span class="item-qty w-6 text-center">${item.qty}</span>
          <button onclick="changeQty(${idx}, 1)" class="qty-btn px-2 bg-gray-200 rounded">+</button>
        </div>
      </div>
    `;
    content.appendChild(div);
  });

  updateSummary();
}





                                              // tƒÉng gi·∫£m s·ªë l∆∞·ª£ng
function updateSummary() {
  if (selectedOrderIndex === -1) return;
  const items = orders[selectedOrderIndex].items;
  const subtotal = items.reduce((sum, i) => sum + i.price * i.qty, 0);
  document.getElementById("subtotal").textContent = `${subtotal.toLocaleString()}ƒë`;
  document.getElementById("total").textContent = `${subtotal.toLocaleString()}ƒë`;
}

                                            // x√≥a gi·ªè h√†ng
async function clearCurrentOrder() {
  if (selectedOrderIndex === -1) return;

  const order = orders[selectedOrderIndex];

  // C·ªông l·∫°i t·ªìn kho v·ªõi t·ª´ng s·∫£n ph·∫©m
  for (const item of order.items) {
    try {
      await fetch('/sale/banhangoff/update-stock', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
        },
        body: JSON.stringify({
           productId: item.productId,
          quantity: item.qty // C·ªông l·∫°i
        })
      });

      // C·ªông l·∫°i t·ªìn kho local
      const productCard = document.querySelector(`.product-card[data-product-code="${item.code}"]`);
      if (productCard) {
        const stockSpan = productCard.querySelector(".product-stock");
        if (stockSpan) {
          const currentStock = parseInt(stockSpan.textContent);
          stockSpan.textContent = currentStock + item.qty;
        }
      }
    } catch (err) {
      console.error("L·ªói khi c·ªông l·∫°i t·ªìn kho", err);
    }
  }

  // X√≥a gi·ªè h√†ng
  order.items = [];
  renderOrder();
}
// c·∫≠p nh·∫≠t n·∫øu LOAD trang
                                      //checkQty
 async function changeQty(index, delta) {
  const order = orders[selectedOrderIndex];
  const item = order.items[index];
  const newQty = item.qty + delta;

  // Ki·ªÉm tra v∆∞·ª£t t·ªìn kho
  if (delta > 0 && newQty > item.quantity) {
    return alert(`Trong kho ch·ªâ c√≤n ${item.quantity} s·∫£n ph·∫©m.`);
  }

  // N·∫øu v·ªÅ 0 th√¨ x√°c nh·∫≠n x√≥a
  if (newQty < 1 && !confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi ƒë∆°n h√†ng?")) {
    return;
  }

  // ‚úÖ KH√îNG g·ªçi update-stock n·ªØa!

  // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng local
  if (newQty <= 0) {
    order.items.splice(index, 1);
  } else {
    item.qty = newQty;
  }

  // ‚úÖ C·∫≠p nh·∫≠t t·ªìn kho hi·ªÉn th·ªã tr√™n UI (ph·∫£n √°nh tr·ª±c quan)
  const card = document.querySelector(`.product-card[data-product-code="${item.code}"]`);
  if (card) {
    const stockText = card.querySelector(".product-stock");
    if (stockText) {
      const currentStock = parseInt(stockText.textContent);
      stockText.textContent = currentStock + (-delta);
    }
  }

  renderOrder();
}


function openModal(product) {
  selectedProduct = product;
  document.getElementById("quantityInput").value = "";
  document.getElementById("quantityModal").classList.add("show");
  document.getElementById("quantityInput").focus();
}

function closeModal() {
  document.getElementById("quantityModal").classList.remove("show");
}

                                    //th√™m v√†o gi·ªè h√†ng
async function addToOrder() {
  const qty = parseInt(document.getElementById("quantityInput").value);
  if (isNaN(qty) || qty <= 0 || !Number.isInteger(qty)) {
    return alert("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng ph√π h·ª£p.");
  }

  const order = orders[selectedOrderIndex];
  const existing = order.items.find(i => i.code === selectedProduct.code);
  const currentQty = existing ? existing.qty : 0;
  if (qty + currentQty > selectedProduct.quantity) {
    return alert(`Trong kho ch·ªâ c√≤n ${selectedProduct.quantity} s·∫£n ph·∫©m.`);
  }

  try {
    // ‚úÖ G·ªåI DUY NH·∫§T 1 L·∫¶N: /add-item (b·ªè update-stock)
    const res = await fetch('/sale/add-item', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
      },
      body: JSON.stringify({
        orderId: order.orderId,
        productId: selectedProduct.productId,
        name: selectedProduct.name,
        price: selectedProduct.price,
        quantity: qty
      })
    });

    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ th√™m s·∫£n ph·∫©m v√†o ƒë∆°n");

    // Tr·ª´ t·ªìn kho ·ªü JS (ph·∫£n √°nh UI)
    selectedProduct.quantity -= qty;

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªìn kho UI
    const productCard = document.querySelector(`.product-card[data-product-code="${selectedProduct.code}"]`);
    if (productCard) {
      const stockSpan = productCard.querySelector(".product-stock");
      if (stockSpan) {
        const currentStock = parseInt(stockSpan.textContent);
        stockSpan.textContent = currentStock - qty;
      }
    }

    // C·∫≠p nh·∫≠t gi·ªè h√†ng tr√™n giao di·ªán
    if (existing) {
      existing.qty += qty;
    } else {
      order.items.push({ ...selectedProduct, qty });
    }

    closeModal();
    renderOrder();
  } catch (error) {
    console.error("L·ªói khi th√™m s·∫£n ph·∫©m", error);
    alert("Kho kh√¥ng ƒë·ªß s·∫£n ph·∫©m ho·∫∑c l·ªói h·ªá th·ªëng.");
  }
}



function bindSelectProductButtons() {
  document.querySelectorAll(".select-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (selectedOrderIndex === -1) {
        alert("H√£y t·∫°o ƒë∆°n h√†ng tr∆∞·ªõc!");
        return;
      }

      const parent = btn.closest(".product-card");
      const img = parent.querySelector("img")?.getAttribute("src") || "/default-image.png";
      const qtyText = parent.querySelector(".product-info div:last-child")?.textContent || "";
      const qty = parseInt(qtyText.replace("Kho: ", "")) || 999;

      openModal({

      productId: parseInt(btn.getAttribute("data-code")),
        name: btn.getAttribute("data-name"),
        price: parseInt(btn.getAttribute("data-price")),
        code: btn.getAttribute("data-code"),
        quantity: qty,
        image: img
      });
    });
  });
}


document.addEventListener("DOMContentLoaded", () => {
  bindSelectProductButtons();
  document.getElementById("quantityInput").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      addToOrder();
    }
  });
});
                                        // hi·ªÉn th·ªã ƒë∆°n h√†ng tr∆∞·ªõc nh·∫ßm h√≥a ƒë∆°n n√™n kh√¥ng s·ª≠a
function showInvoice() {
    if (selectedOrderIndex === -1) return alert("B·∫°n ch∆∞a ch·ªçn ƒë∆°n h√†ng!");

     const currentOrder = orders[selectedOrderIndex];

    // ‚ö†Ô∏è Ki·ªÉm tra n·∫øu ƒë∆°n h√†ng kh√¥ng c√≥ s·∫£n ph·∫©m
    if (!currentOrder.items || currentOrder.items.length === 0) {
        return alert("ƒê∆°n h√†ng hi·ªán t·∫°i ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!");
    }


    // 1. Th·ªùi gian v√† m√£ h√≥a ƒë∆°n th·ª±c t·∫ø
    document.getElementById("invTime").innerText = new Date().toLocaleString();
    document.getElementById("invCode").innerText = currentOrder.orderCode || `HD${selectedOrderIndex + 1}`;
document.getElementById("invCode").dataset.orderId = currentOrder.orderId;

    // 2. L·∫•y t√™n kh√°ch h√†ng ho·∫∑c m·∫∑c ƒë·ªãnh "Kh√°ch l·∫ª"
    const customerText = document.getElementById("customerResult")?.innerText.trim();
    const fallbackTexts = ["Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.", "Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng."];
    const customerName = (!customerText || fallbackTexts.includes(customerText)) ? "Kh√°ch l·∫ª" : customerText;
    document.getElementById("invCustomer").innerText = customerName;

    // 3. Hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m
    const tbody = document.getElementById("invItems");
    tbody.innerHTML = "";
    const items = currentOrder.items;
    let total = 0;

    items.forEach((item, i) => {
        const itemTotal = item.qty * item.price;
        total += itemTotal;
        const tr = `
            <tr>
                <td class="border px-2 py-1 text-center">${i + 1}</td>
                <td class="border px-2 py-1">${item.name}</td>
                <td class="border px-2 py-1 text-center">${item.qty}</td>
                <td class="border px-2 py-1 text-right">${item.price.toLocaleString()}ƒë</td>
                <td class="border px-2 py-1 text-right">${itemTotal.toLocaleString()}ƒë</td>
            </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", tr);
    });

    // 4. G√°n t·ªïng ti·ªÅn
    document.getElementById("invTotal").innerText = total.toLocaleString() + "ƒë";

    // 5. Hi·ªÉn th·ªã popup h√≥a ƒë∆°n
    document.getElementById("invoiceModal").classList.add("show");
    document.getElementById("invoiceBackdrop").classList.add("show");
}

function closeInvoice() {
    document.getElementById("invoiceModal").classList.remove("show");
    document.getElementById("invoiceBackdrop").classList.remove("show");
}


function searchCustomer() {
    const phoneInput = document.getElementById("phoneInput");
    const phone = phoneInput.value.trim();
    const resultDiv = document.getElementById("customerResult");

    if (!phone) {
        resultDiv.innerText = "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.";
        return;
    }

    fetch(`/api/customers/search?phone=${encodeURIComponent(phone)}`)
        .then(response => {
            if (!response.ok) throw new Error("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng");
            return response.json();
        })
        .then(data => {
            resultDiv.innerText = `${data.name} - ${data.phone}`;
        })
        .catch(error => {
            resultDiv.innerText = "Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.";
            console.error(error);
        });
}

// M·ªü modal ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
function showPaymentOptions() {
    document.getElementById('paymentOptionModal').classList.add('active');
}

// ƒê√≥ng modal ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
function closePaymentOptionModal() {
    document.getElementById('paymentOptionModal').classList.remove('active');
}

                                               // M·ªü modal thanh to√°n ti·ªÅn m·∫∑t
function payWithCash() {
    closePaymentOptionModal(); // ·∫®n modal ch·ªçn ph∆∞∆°ng th·ª©c

    const cashModal = document.getElementById('cashPaymentModal');
    cashModal.classList.add('active'); // Hi·ªán modal ti·ªÅn m·∫∑t

    // L·∫•y t·ªïng ti·ªÅn t·ª´ invoice
    const rawTotal = document.getElementById('invTotal').innerText;
    const numberOnly = rawTotal.replace(/[^\d]/g, '');
    const totalAmount = parseInt(numberOnly || "0");

    // ‚úÖ Reset d·ªØ li·ªáu modal
    document.getElementById('cashReceived').value = '';
    document.getElementById('cashChange').textContent = '';
    document.getElementById('cashTotal').innerText = formatCurrency(totalAmount);

    cashModal.dataset.total = totalAmount;
}


// Format ti·ªÅn VND
function formatCurrency(amount) {
    return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
}

// ƒê√≥ng modal thanh to√°n ti·ªÅn m·∫∑t
function closeCashModal() {
    document.getElementById('cashPaymentModal').classList.remove('active');
}

                                   // C·∫≠p nh·∫≠t ti·ªÅn th·ª´a khi kh√°ch nh·∫≠p ti·ªÅn
document.getElementById('cashReceived').addEventListener('input', function () {
    const received = parseInt(this.value || "0");
    const total = parseInt(document.getElementById('cashPaymentModal').dataset.total || "0");
    const change = received - total;

    const changeDisplay = document.getElementById('cashChange');
    changeDisplay.textContent = change >= 0 ? formatCurrency(change) : 'Ch∆∞a ƒë·ªß';
});
                                        // thanh to√°n ti·ªÅn m·∫∑t
function confirmCashPayment() {
    const received = parseInt(document.getElementById('cashReceived').value || "0");
    const total = parseInt(document.getElementById('cashPaymentModal').dataset.total || "0");

    if (received < total) {
        alert('Kh√°ch ƒë∆∞a ch∆∞a ƒë·ªß ti·ªÅn!');
        return;
    }

    const currentOrder = orders[selectedOrderIndex];
    const orderId = currentOrder.orderId; // ƒê·ªïi t·ª´ orderCode ‚Üí orderId

    const customerText = document.getElementById("customerResult")?.innerText.trim();
    const fallbackTexts = ["Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.", "Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng."];
    const isGuest = !customerText || fallbackTexts.includes(customerText);
    const customerCode = isGuest ? null : (currentOrder.customerCode || null);
    const description = isGuest ? "Kh√°ch l·∫ª" : customerText;

    const requestBody = {
        orderId: orderId,
        paymentMethod: "CASH",
        customerCode: customerCode,
        address: null,
        phone: null,
        description: description,
        items: currentOrder.items.map(item => ({
            productId: parseInt(item.code), // chuy·ªÉn code th√†nh productId
            name: item.name,
            price: item.price,
            quantity: item.qty
        }))
    };
console.log("D·ªÆ LI·ªÜU G·ª¨I:", requestBody);
console.log("ITEMS:", currentOrder.items);
    fetch('/orders/thanh-toan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
        },
        body: JSON.stringify(requestBody)
    }).then(res => {
        if (!res.ok) throw new Error("L·ªói thanh to√°n!");
        return res.json();
    }).then(orderData => {
        showOrderInvoiceModal(orderData); // d√πng function m·ªõi
        closeCashModal();

        // X√≥a ƒë∆°n h√†ng kh·ªèi danh s√°ch
        orders.splice(selectedOrderIndex, 1);
        localStorage.setItem("pendingOrders", JSON.stringify(orders));
    }).catch(err => {
        console.error(err);
        alert("‚ùå Giao d·ªãch th·∫•t b·∫°i!");
    });
}


document.addEventListener("DOMContentLoaded", function () {
    const savedOrders = localStorage.getItem("pendingOrders");
    if (savedOrders) {
        orders = JSON.parse(savedOrders);
        selectedOrderIndex = orders.length > 0 ? 0 : -1;
        renderOrderTabs();
        renderOrder();
        localStorage.removeItem("pendingOrders");
    }
});
// ‚úÖ Hi·ªÉn th·ªã h√≥a ƒë∆°n
function showOrderInvoiceModal(order) {
    // ƒêi·ªÅn th√¥ng tin c∆° b·∫£n
    document.getElementById("invoiceCode").innerText = "ƒê∆°n #" + order.orderId;
    document.getElementById("invoiceDate").innerText = new Date(order.orderDate).toLocaleString();
    document.getElementById("invoiceCustomer").innerText = order.customerName || "Kh√°ch l·∫ª";

    // Hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m
    const tbody = document.getElementById("invoiceItems");
    tbody.innerHTML = ""; // clear c≈©

    let total = 0;
    order.items.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;

        tbody.insertAdjacentHTML("beforeend", `
            <tr>
                <td style="border: 1px solid #ccc; padding: 4px;">${item.productName || item.name}</td>
                <td style="border: 1px solid #ccc; padding: 4px; text-align: center;">${item.quantity}</td>
                <td style="border: 1px solid #ccc; padding: 4px; text-align: right;">${item.price.toLocaleString()}ƒë</td>
                <td style="border: 1px solid #ccc; padding: 4px; text-align: right;">${itemTotal.toLocaleString()}ƒë</td>
            </tr>
        `);
    });

    document.getElementById("invoiceTotal").innerText = total.toLocaleString() + "ƒë";

    // Hi·ªÉn th·ªã modal
    document.getElementById("invoiceModal-IV").style.display = "flex";
}





<!--let provincesData = [];-->
<!--fetch("https://provinces.open-api.vn/api/?depth=3")-->
<!--  .then(res => res.json())-->
<!--  .then(data => {-->
<!--    provincesData = data;-->
<!--    const ps = document.getElementById("provinceSelect");-->
<!--    data.forEach(p => { let o = document.createElement("option"); o.value = p.code; o.text = p.name; ps.add(o); });-->
<!--  });-->

<!--document.getElementById("provinceSelect").addEventListener("change", function() {-->
<!--  const prov = provincesData.find(p => p.code == this.value);-->
<!--  const ds = document.getElementById("districtSelect"), ws = document.getElementById("wardSelect");-->
<!--  ds.innerHTML = '<option value="">Ch·ªçn huy·ªán / qu·∫≠n</option>';-->
<!--  ws.innerHTML = '<option value="">Ch·ªçn x√£ / ph∆∞·ªùng</option>';-->
<!--  ws.disabled = true;-->
<!--  if (!prov) { ds.disabled = true; return; }-->
<!--  prov.districts.forEach(d => { let o = document.createElement("option"); o.value = d.code; o.text = d.name; ds.add(o); });-->
<!--  ds.disabled = false;-->
<!--});-->

<!--document.getElementById("districtSelect").addEventListener("change", function() {-->
<!--  const prov = provincesData.find(p => p.code == document.getElementById("provinceSelect").value);-->
<!--  const dist = prov?.districts.find(d => d.code == this.value);-->
<!--  const ws = document.getElementById("wardSelect");-->
<!--  ws.innerHTML = '<option value="">Ch·ªçn x√£ / ph∆∞·ªùng</option>';-->
<!--  if (!dist) { ws.disabled = true; return; }-->
<!--  dist.wards.forEach(w => { let o = document.createElement("option"); o.value = w.name; o.text = w.name; ws.add(o); });-->
<!--  ws.disabled = false;-->
<!--});-->

const modal = document.getElementById("customerModal");
document.getElementById("openCustomerFormBtn").addEventListener("click", () => modal.style.display = "flex");
document.getElementById("closeCustomerModalBtn").addEventListener("click", () => modal.style.display = "none");
modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });


document.getElementById("customerForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const fd = new FormData(this);

  const name = fd.get("name");
  const phone = fd.get("phone");
  const email = fd.get("email");
  const address = `${fd.get("ward")}, ${fd.get("district")}, ${fd.get("province")}`;

  // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i tr√πng
  const phoneRes = await fetch(`/api/customers/checkPhone?phone=${encodeURIComponent(phone)}`);
  const phoneExists = await phoneRes.json();
  if (phoneExists) {
    alert("S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i!");
    return;
  }

  // Ki·ªÉm tra email tr√πng
  const emailRes = await fetch(`/api/customers/checkEmail?email=${encodeURIComponent(email)}`);
  const emailExists = await emailRes.json();
  if (emailExists) {
    alert("Email ƒë√£ t·ªìn t·∫°i!");
    return;
  }

  const customer = { name, phone, email, address };

  fetch("/api/customers/addKhachHang", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(customer)
  })
    .then(res => res.ok ? res.json() : Promise.reject("L·ªói server"))
    .then(data => {
      alert("Th√™m kh√°ch h√†ng th√†nh c√¥ng");
      modal.style.display = "none";
      this.reset();
    })
    .catch(err => alert(err));
});

/* code js c·ªßa th·∫±ng ch√≥ h√≥a ƒë∆°n */
function openInvoiceModal() {
    const modal = document.getElementById("invoiceModal-IV");
    if (modal) modal.style.display = "flex";
}

function closeInvoiceModal() {
    const modal = document.getElementById("invoiceModal-IV");
    if (modal) {
        modal.style.display = "none";
        location.reload(); // ‚úÖ Reload trang sau khi ƒë√≥ng modal
    }
}



function showInvoiceModal(invoiceData) {
    document.getElementById("invoiceCode").innerText = invoiceData.invoiceCode;
    document.getElementById("invoiceDate").innerText = new Date(invoiceData.createdAt).toLocaleString();

    // ‚úÖ N·∫øu c√≥ t√™n kh√°ch th√¨ hi·ªÉn th·ªã, ng∆∞·ª£c l·∫°i hi·ªÉn th·ªã "Kh√°ch l·∫ª"
    const customerName = invoiceData.customerName;
    document.getElementById("invoiceCustomer").innerText = customerName && customerName.trim() !== ''
        ? customerName
        : "Kh√°ch l·∫ª";

    const tbody = document.getElementById("invoiceItems");
    tbody.innerHTML = "";

    let total = 0;
    invoiceData.invoiceItems.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        tbody.insertAdjacentHTML("beforeend", `
            <tr>
                <td>${item.productName}</td>
                <td>${item.quantity}</td>
                <td>${item.price.toLocaleString()}ƒë</td>
                <td>${itemTotal.toLocaleString()}ƒë</td>
            </tr>
        `);
    });

    document.getElementById("invoiceTotal").innerText = total.toLocaleString() + "ƒë";
    openInvoiceModal();
}

function exportInvoiceToPDF() {
    const invoice = document.getElementById("invoiceToPrint");
    const modal = document.getElementById("invoiceModal-IV");

    const wasHidden = modal.style.display === "none" || getComputedStyle(modal).display === "none";

    if (wasHidden) {
        // ‚úÖ Hi·ªán modal t·∫°m ƒë·ªÉ DOM render n·ªôi dung
        modal.style.display = "flex";
        modal.style.visibility = "hidden"; // ·∫©n v·ªõi ng∆∞·ªùi d√πng
    }

    // ‚úÖ Delay 200ms ƒë·ªÉ DOM render xong tr∆∞·ªõc khi html2pdf ch·∫°y
    setTimeout(() => {
        html2pdf().set({
            margin: 5,
            filename: 'hoa-don.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a5', orientation: 'portrait' }
        }).from(invoice).save().then(() => {
            // ‚úÖ ·∫®n l·∫°i modal n·∫øu ban ƒë·∫ßu ƒëang ·∫©n
            if (wasHidden) {
                modal.style.display = "none";
                modal.style.visibility = "visible";
            }
        });
    }, 200);
}

                                // xem chi ti·∫øt h√≥a ƒë∆°n


function viewInvoiceDetail() {
    const code = document.getElementById("invoiceCode").innerText;
    const date = document.getElementById("invoiceDate").innerText;
    const customer = document.getElementById("invoiceCustomer").innerText;
    const total = document.getElementById("invoiceTotal").innerText;

    const rows = document.querySelectorAll("#invoiceItems tr");
    let itemList = "";

    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length === 4) {
            itemList += `<tr>
                <td>${cells[0].innerText}</td>
                <td>${cells[1].innerText}</td>
                <td>${cells[2].innerText}</td>
                <td>${cells[3].innerText}</td>
            </tr>`;
        }
    });

    const html = `
        <p><strong>M√£ h√≥a ƒë∆°n:</strong> ${code}</p>
        <p><strong>Th·ªùi gian:</strong> ${date}</p>
        <p><strong>Kh√°ch h√†ng:</strong> ${customer}</p>
        <p><strong>S·∫£n ph·∫©m:</strong></p>
        <table border="1" cellpadding="4" cellspacing="0" style="width: 100%; border-collapse: collapse; margin-top: 5px;">
            <thead>
                <tr>
                    <th>SP</th><th>SL</th><th>ƒêG</th><th>TT</th>
                </tr>
            </thead>
            <tbody>
                ${itemList}
            </tbody>
        </table>
        <p style="margin-top: 10px;"><strong>T·ªïng:</strong> ${total}</p>
    `;

    document.getElementById("invoiceDetailContent").innerHTML = html;
    document.getElementById("invoiceDetailModal").style.display = "flex";
}

function closeInvoiceDetailModal() {
    document.getElementById("invoiceDetailModal").style.display = "none";
}
function payOnline() {
  const amountText = document.getElementById('invTotal').innerText;
  const amount = parseInt(amountText.replace(/[^\d]/g, ''));
  const orderId = document.getElementById('invCode').dataset.orderId;

  if (!orderId || amount <= 0) {
    alert("Thi·∫øu m√£ ƒë∆°n h√†ng ho·∫∑c s·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá.");
    return;
  }

  // ‚úÖ L∆∞u tr·∫°ng th√°i ƒë∆°n h√†ng
  localStorage.setItem("orders_backup", JSON.stringify(orders));
  localStorage.setItem("selectedOrderIndex_backup", selectedOrderIndex);

  // ‚úÖ G·ª≠i form t·ªõi PayOS
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/orders/createPaymentLinkSale';

  const orderIdInput = document.createElement('input');
  orderIdInput.type = 'hidden';
  orderIdInput.name = 'orderId';
  orderIdInput.value = orderId;

  const amountInput = document.createElement('input');
  amountInput.type = 'hidden';
  amountInput.name = 'amount';
  amountInput.value = amount;

  form.appendChild(orderIdInput);
  form.appendChild(amountInput);
  document.body.appendChild(form);
  form.submit();
}


window.addEventListener("DOMContentLoaded", () => {
  const backup = localStorage.getItem("orders_backup");
  if (backup) {
    orders = JSON.parse(backup);
    selectedOrderIndex = parseInt(localStorage.getItem("selectedOrderIndex_backup")) || 0;

    // Sau khi kh√¥i ph·ª•c, render l·∫°i
    renderOrderTabs();
    renderOrder();

    // ‚úÖ D·ªçn d·∫πp storage
    localStorage.removeItem("orders_backup");
    localStorage.removeItem("selectedOrderIndex_backup");
  }
});

function closeQRModal() {
  document.getElementById("qrPaymentModal").style.display = "none";
}
function confirmQRPayment() {
  closeQRModal();

  const currentOrder = orders[selectedOrderIndex];
  const orderId = currentOrder.orderId; // ‚úÖ D√πng orderId

  const customerText = document.getElementById("customerResult")?.innerText.trim();
  const fallbackTexts = ["Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.", "Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng."];
  const isGuest = !customerText || fallbackTexts.includes(customerText);
  const customerCode = isGuest ? null : (currentOrder.customerCode || null);
  const description = isGuest ? "Kh√°ch l·∫ª" : customerText;

  const requestBody = {
    orderId: orderId, // ‚úÖ thay v√¨ orderCode
    customerCode: customerCode,
    address: null,
    phone: null,
    description: description,
    amount: currentOrder.items.reduce((sum, item) => sum + item.price * item.qty, 0),
    items: currentOrder.items.map(item => ({
      productId: parseInt(item.productId || item.code), // ‚úÖ l·∫•y productId
      name: item.name,
      price: item.price,
      quantity: item.qty
    }))
  };

  fetch('/orders/thanh-toan-online', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
    },
    body: JSON.stringify(requestBody)
  })
    .then(res => {
      if (!res.ok) throw new Error("L·ªói khi x√°c nh·∫≠n chuy·ªÉn kho·∫£n!");
      return res.json();
    })
    .then(orderData => {
      orders.splice(selectedOrderIndex, 1);
      localStorage.setItem("pendingOrders", JSON.stringify(orders));
<!--      showOrderInvoiceModal(orderData); // ‚úÖ g·ªçi l·∫°i modal hi·ªÉn th·ªã-->
    })
    .catch(err => {
      console.error(err);
      alert("‚ùå Giao d·ªãch th·∫•t b·∫°i!");
    });
}




                                                                 //Ajax cho ph·∫ßn l·ªçc s·∫£n ph·∫©m


document.getElementById("categorySelect").addEventListener("change", function () {
    const selectedCategory = this.value;

    fetch(`/sale/banhangoff/products?category=${selectedCategory}`)
        .then(response => {
            if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m");
            return response.json();
        })
        .then(products => {
            const productGrid = document.querySelector(".product-grid");
            productGrid.innerHTML = "";

            products.forEach(product => {
                const productCard = document.createElement("div");
                productCard.className = "product-card border p-2 rounded shadow text-sm";
                productCard.setAttribute("data-product-code", product.productId); // ‚úÖ ƒë·ªÉ update t·ªìn kho JS

              productCard.innerHTML = `
    <div class="product-image-wrapper text-center">
        <img src="/loadImage?imageName=${product.productImage}" alt="·∫¢nh s·∫£n ph·∫©m" class="product-image w-20 h-20 object-cover mx-auto">
    </div>
    <div class="product-name font-semibold text-center mt-1 truncate">${product.productName}</div>
    <div class="product-info text-xs text-gray-600 text-center">
        <div>Gi√°: ${Number(product.price).toLocaleString()}ƒë</div>
        <div class="product-stock">Kho: ${product.quantity}</div>
    </div>
    <button class="select-btn bg-green-500 text-white px-2 py-1 rounded mt-2 w-full text-xs"
        data-id="${product.productId}"
        data-code="${product.productId}"
        data-name="${product.productName}"
        data-price="${product.price}"
        data-quantity="${product.quantity}">
        Ch·ªçn
    </button>
`;

                productGrid.appendChild(productCard);
            });

            bindSelectProductButtons();
        })
        .catch(error => {
            console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m:", error);
        });
});



    const searchInput = document.getElementById("searchInput");
    const productGrid = document.querySelector(".product-grid");
                                                                  //search
searchInput.addEventListener("input", function () {
    const keyword = searchInput.value;

    fetch(`/sale/banhangoff/search?productName=${encodeURIComponent(keyword)}`)
        .then(res => {
            if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m");
            return res.json();
        })
        .then(products => {
            productGrid.innerHTML = '';

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card bg-white border rounded p-2';

                card.innerHTML = `
                    <div class="product-image-wrapper flex justify-center mb-2">
                        <img src="/loadImage?imageName=${product.productImage}" alt="·∫¢nh s·∫£n ph·∫©m" class="product-image w-[64px] h-[64px] object-cover">
                    </div>
                    <div class="product-name font-semibold text-center mb-1">${product.productName}</div>
                    <div class="product-info text-sm text-center">
                        <div>Gi√°: ${Number(product.price).toLocaleString()}ƒë</div>
                        <div>Kho: ${product.quantity}</div>
                    </div>
                    <div class="flex justify-center mt-2">
                        <button class="select-btn bg-green-500 text-white px-3 py-1 rounded"
                            data-code="${product.productId}"
                            data-name="${product.productName}"
                            data-price="${product.price}"
                            data-quantity="${product.quantity}">
                            Ch·ªçn
                        </button>
                    </div>
                `;
                productGrid.appendChild(card);
            });

            bindSelectProductButtons(); // ƒê·ª´ng qu√™n g·∫Øn l·∫°i s·ª± ki·ªán
        })
        .catch(err => {
            console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m:", err);
        });
});




// G·ªçi m·ªôt l·∫ßn khi trang v·ª´a load
attachSelectEvents();





</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const restoredOrder = /*[[${restoredOrder} != null ? ${restoredOrder} : 'null']]*/ null;

    if (restoredOrder) {
        const order = {
            orderId: restoredOrder.orderId,
            orderCode: restoredOrder.orderCode,
            items: restoredOrder.orderDetails.map(detail => ({
                productId: detail.product.productId,
                name: detail.product.productName,
                qty: detail.quantity,
                price: detail.price,
                image: detail.product.productImage // s·ª≠a t√™n field n·∫øu kh√°c
            }))
        };

        orders.push(order);
        selectedOrderIndex = orders.length - 1;
        renderOrderTabs();
        renderOrder();
    }
    /*]]>*/
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="/js/html2pdf.bundle.min.js"></script>
</body>
</html>